{% extends 'index.html' %}
{% load static %}
{% load mathfilters %}
{% load replace %}

{% block nav_title %}
    <h4 align="center">Карта </h4>
{% endblock %}

{% block top_nav_buttons_left %}
    <li class="nav-item px-3">
        {% url 'index_url' as index_page_url %}
        <a class="btn btn-outline-secondary" href="{{index_page_url}}">На главную</a>
    </li>
{% endblock %}             

{% block title %}Карта{% endblock %}

{% block header %}
	<!-- OpenLayers - https://openlayers.org/download/ -->

    <link rel="stylesheet" href="{% static "openlayer-6.5.0/ol.css" %}" type="text/css">
    <script type="text/javascript" src="{% static "openlayer-6.5.0/ol.js" %}"></script>
	<script src="{% static "js/elm-pep.js" %}"></script>

	<!-- https://github.com/swisnl/jQuery-contextMenu -->
	<link rel="stylesheet" href="{% static "css/jquery.contextMenu.min.css" %}">
	<script src="{% static "js/jquery.contextMenu.min.js" %}"></script>
	<script src="{% static "js/jquery.ui.position.js" %}"></script>
	
	<script src="{% static "js/ElementQueries.js" %}"></script>
	<script src="{% static "js/ResizeSensor.js" %}"></script>

	<script src="{% static "js/jquery.splitter.js" %}"></script>
    <link href="{% static "css/jquery.splitter.css" %}" rel="stylesheet"/>	
	<link rel="stylesheet" href="{% static "css/mystyles.css" %}">

{% endblock %}

{% block content %}
	<div id="fullscreen" class="fullscreen">
    	
		<!-- Разметка окон с параметрами и превью -->
		{% for entity in objects.entity_list %}
			<div style="display: none;">
				<div id="popup_{{entity.entity_id}}" style="position:absolute;">
				</div>
			</div>
		{% endfor %}
	
		<!-- Разметка панели списка отображаемых объектов -->
		<div class="sidepanel" id="sidepanel">
			<div id="objectslist" class="list-group" style="height:100%; width: 300px;">
				<div id="containerlist" class="p-1" style="height:100%;">
					<ul id="list" class="list">
						{% for entity in objects.entity_list %}
							<a href="#" id="{{entity.entity_id}}" class="list-group-item list-group-item-action">
								<div class="d-flex w-100 justify-content-between">
									<div id="{{entity.entity_id}}" class="show" title="Указатель на {{entity.model}}">
										<h5 class="mb-1 model">{{entity.model}}</h5>
										<p class="mb-1 number">Номер: <i>{{entity.number}}</i></p>
									</div>
									<div class="btn-group dropend">
										<button type="button" class="btn btn-outline-primary btn-sm dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false" style="margin-right: -12px;">
											{% comment %}  {% endcomment %}
										</button>
										<ul class="dropdown-menu">
											<li><div class="dropdown-item">
												<div class="row">
													<div class="col">
														<label for="{{entity.entity_id}}" class="form-label">Показать (скрыть) указатель</label>
													</div>
													<div class="col-2 gsettings-col">
														<div class="form-check form-switch">
															<input id="{{entity.entity_id}}" class="form-check-input view-object" type="checkbox" checked>
														</div>
													</div>
												</div>
											</div></li>

											{% for stream in entity.stream_links %}
												{% if forloop.counter is 1 %}
													<li><hr class="dropdown-divider"></li>
												{% endif %}
												<li><div class="dropdown-item">
													<div class="row">
														<div class="col">
															<label for="{{entity.entity_id}}_{{stream.stream_id}}" class="form-label">{{stream.stream_alias}}</label>
														</div>
														<div class="col-2 gsettings-col">
															<div class="form-check form-switch">
																<input id="{{entity.entity_id}}_{{stream.stream_id}}" class="form-check-input" type="checkbox">
															</div>
														</div>
													</div>
												</div></li>
											{% endfor %}
										</ul>
									</div>
								</div>
							</a>
						{% endfor %}
					</ul>
				</div>
				<div class="container">
					<div class="input-group">
						<input id="search" class="search" placeholder="Поиск" onkeyup="searchFunction()"/>
						<button type="button" class="btn btn-outline-secondary btn-global-settings" data-bs-toggle="modal" data-bs-target="#globalSettingsModal">
							<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-gear" viewBox="0 0 16 16">
								<path d="M8 4.754a3.246 3.246 0 1 0 0 6.492 3.246 3.246 0 0 0 0-6.492zM5.754 8a2.246 2.246 0 1 1 4.492 0 2.246 2.246 0 0 1-4.492 0z"/>
								<path d="M9.796 1.343c-.527-1.79-3.065-1.79-3.592 0l-.094.319a.873.873 0 0 1-1.255.52l-.292-.16c-1.64-.892-3.433.902-2.54 2.541l.159.292a.873.873 0 0 1-.52 1.255l-.319.094c-1.79.527-1.79 3.065 0 3.592l.319.094a.873.873 0 0 1 .52 1.255l-.16.292c-.892 1.64.901 3.434 2.541 2.54l.292-.159a.873.873 0 0 1 1.255.52l.094.319c.527 1.79 3.065 1.79 3.592 0l.094-.319a.873.873 0 0 1 1.255-.52l.292.16c1.64.893 3.434-.902 2.54-2.541l-.159-.292a.873.873 0 0 1 .52-1.255l.319-.094c1.79-.527 1.79-3.065 0-3.592l-.319-.094a.873.873 0 0 1-.52-1.255l.16-.292c.893-1.64-.902-3.433-2.541-2.54l-.292.159a.873.873 0 0 1-1.255-.52l-.094-.319zm-2.633.283c.246-.835 1.428-.835 1.674 0l.094.319a1.873 1.873 0 0 0 2.693 1.115l.291-.16c.764-.415 1.6.42 1.184 1.185l-.159.292a1.873 1.873 0 0 0 1.116 2.692l.318.094c.835.246.835 1.428 0 1.674l-.319.094a1.873 1.873 0 0 0-1.115 2.693l.16.291c.415.764-.42 1.6-1.185 1.184l-.291-.159a1.873 1.873 0 0 0-2.693 1.116l-.094.318c-.246.835-1.428.835-1.674 0l-.094-.319a1.873 1.873 0 0 0-2.692-1.115l-.292.16c-.764.415-1.6-.42-1.184-1.185l.159-.291A1.873 1.873 0 0 0 1.945 8.93l-.319-.094c-.835-.246-.835-1.428 0-1.674l.319-.094A1.873 1.873 0 0 0 3.06 4.377l-.16-.292c-.415-.764.42-1.6 1.185-1.184l.292.159a1.873 1.873 0 0 0 2.692-1.115l.094-.319z"/>
							</svg>
							<span class="visually-hidden">Button</span>
						</button>
					</div>
				</div>
			</div>
		</div>

		<div id="widget" style="display: flex; height:100%; width:100%;">
			<!-- Разметка карты -->
			<div id="map" class="map">
				<div id='hintmap'>
					<p></p>
				</div>
			</div>

			<div class="streampanel">
				<div id="objectstreamlist" class="list-group" style="height:100%;">
					<div class="overflow-auto p-1" style="height:100%">
						<ul id="liststream" class="list">
						</ul>
					</div>
				</div>
			</div>
		</div>

		<!-- Модальное окно с настройками отбражаемых объектов -->
		<div class="modal fade" id="settingsModal" tabindex="-1" aria-labelledby="settingsModalTitle" aria-hidden="true">
			<div class="modal-dialog modal-dialog-centered">
				<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="settingsModalTitle">Автомобиль</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
				</div>
				<div class="modal-body">
					<div id="settingsModalContent"></div>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Закрыть</button>
				</div>
				</div>
			</div>
		</div>

		<!-- Модальное окно глобальных настроек -->
		<div class="modal fade" id="globalSettingsModal" tabindex="-1" aria-labelledby="globalSettingsModalTitle" aria-hidden="true">
			<div class="modal-dialog modal-dialog-centered">
				<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="globalSettingsModalTitle">Общие настройки</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
				</div>
				<div class="modal-body">
					<div id="globalSettingsModalContent" class="container">
						<div class="row gsettings-row">
							<div class="col-4">
								<label for="customRange1" class="form-label">Масштаб текста списка датчиков</label>
							</div>
							<div class="col gsettings-col">
								<input type="range" class="form-control-range gsettings-range" min="9" max="20" step="1.0" value="{{settings_size_text}}" id="customRange1" oninput="dragRange1()">
							</div>
							<div class="col-2 gsettings-col">
								<p id="contentRange1" class="gsettings-val">{{settings_size_text}}px</p>
							</div>
						</div>
						<div class="row gsettings-row">
							<div class="col-4">
								<label for="customRange2" class="form-label">Масштаб превью видеопотока</label>
							</div>
							<div class="col gsettings-col">
								<input type="range" class="form-control-range gsettings-range" min="150" max="500" step="10.0" value="{{settings_size_preview}}" id="customRange2" oninput="dragRange2()">
							</div>
							<div class="col-2 gsettings-col">
								<p id="contentRange2" class="gsettings-val">{{settings_size_preview}}px</p>
							</div>							
						</div>
						<div class="row gsettings-row">
							<div class="col-4">
								<label for="customRange3" class="form-label">Прозрачность окон указателей</label>
							</div>
							<div class="col gsettings-col">
								<input type="range" class="form-control-range gsettings-range" min="0.3" max="1.0" step="0.1" value="{{settings_opacity_windows|replace}}" id="customRange3" oninput="dragRange3()">
							</div>
							<div class="col-2 gsettings-col">
								<p id="contentRange3" class="gsettings-val">{{settings_opacity_windows|mul:100|add:0}}%</p>
							</div>							
						</div>
						<div class="row">
							<div class="col">
								<label for="all_show" class="form-label">Показать (скрыть) все указатели</label>
							</div>
							<div class="col-2 gsettings-col">
								<div class="form-check form-switch">
									<input id="all_show" class="form-check-input" type="checkbox" checked>
								</div>
							</div>
						</div>
						<div class="row">
							<div class="col">
								<label for="all_show_param" class="form-label">Показать (скрыть) все окна с параметрами</label>
							</div>
							<div class="col-2 gsettings-col">
								<div class="form-check form-switch">
									<input id="all_show_param" class="form-check-input" type="checkbox" checked>
								</div>
							</div>
						</div>
					</div>
				</div>
				<div class="modal-footer">
					<button type="button" id="btn_reset_settings" class="btn btn-outline-danger" data-bs-toggle="modal" data-bs-target="#resetModal">Сброс</button>
					<button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Закрыть</button>
				</div>
				</div>
			</div>
		</div>

		<!-- Модальное окно подтверждения сброса настроек -->
		<div class="modal fade" id="resetModal" tabindex="-1" aria-labelledby="resetModalTitle" aria-hidden="true">
			<div class="modal-dialog modal-sm modal-dialog-centered">
				<div class="modal-content">
					<div class="modal-header">
						<h5 class="modal-title" id="resetModalTitle">Сброс настроек</h5>
						<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
					</div>
					<div class="modal-body">
						<div id="resetModalContent">
							<p><i>Будут сброшены настройки отображения указателей и видеопотоков, а также перезагружена страница</i></p>
							<b>Вы уверены?</b>
						</div>
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-outline-danger" id="btn_reset">Сброс</button>
						<button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Отмена</button>
					</div>
				</div>
			</div>
		</div>
    </div>

	<!-- Подключение класса отображаемого объекта, в дальнейшем "отображаемый объект" и "Entity" - синонимы -->
	<script src="{% static "js/Entity.js" %}"></script>

	<!-- Подключение класса - контейнера хранения Entity. EntityMap наследуется от Map -->
	<script src="{% static "js/EntityMap.js" %}"></script>


    <script>
		$('#all_show_param').click();

		// Функционал подгона высоты родительского div
		$('#fullscreen').css({'height':`${document.documentElement.clientHeight-70}px`});
		window.addEventListener('resize', function() {
			$('#fullscreen').css({'height':`${document.documentElement.clientHeight-70}px`});
		});

		// Функционал поиска Entity в списке
		function searchFunction() {
			var input = document.getElementById("search");
			var filter = input.value.toUpperCase();
			var ul = document.getElementById("list");
			var a = ul.getElementsByTagName("a"); 

			// Перебирайте все элементы списка и скрывайте те, которые не соответствуют поисковому запросу
			for (i = 0; i < a.length; i++) {
				var context_model = a[i].getElementsByTagName("h5")[0];
				var context_number = a[i].getElementsByTagName("p")[0];
				if (context_model.innerHTML.toUpperCase().indexOf(filter) > -1 || context_number.innerHTML.toUpperCase().indexOf(filter) > -1) {
					a[i].style.display = "";
				} else {
					a[i].style.display = "none";
				}
			}
		}

		// Функционал сортировки в списке
		$(function() {
			$("#list").sortable();
			$("#list").disableSelection();
			$("#liststream").sortable();
			$("#liststream").disableSelection();
		});

		var streamPanelEl = document.getElementById('streampanel');
		var splitter = $('#widget').split({
			orientation: 'vertical',
			limit: 150,
			position: $('#widget').width() - 150, 
			onDrag: function(event) {
				map.updateSize();
			}
		});
		$('.vsplitter').css({'background-color': 'darkgrey'});
		$('.vsplitter').css({'z-index': '0'});
		
		// Создание объекта-указателя Entity на карте 
		var iconStyle = new ol.style.Style({
			image: new ol.style.Icon({
				anchor: [0.4475, 32],
				anchorXUnits: 'fraction',
				anchorYUnits: 'pixels',
				src: '{% static "media/icon.png" %}',
			}),
		});

		// Создание контейнера Entity
		entityMap = new EntityMap();

		// Парсинг полученных Entity
		{% for entity in objects.entity_list %}
			(function(entityMap){
				var entityOBJ = new Entity('{{entity.entity_id}}');
				entityOBJ.setNumber = '{{entity.number}}';
				entityOBJ.setModel = '{{entity.model}}';
				entityOBJ.setPositionN = '{{entity.position_n}}';
				entityOBJ.setPositionE = '{{entity.position_e}}';

				var params = new Array();
				{% for param in entity.params %}
					var paramMap = new Map();
					paramMap.set('params_id', '{{param.params_id}}');
					paramMap.set('params_alias', '{{param.params_alias}}');
					paramMap.set('params_value', '{{param.params_value}}');
					params.push(paramMap);
				{% endfor %}
				entityOBJ.setParams = params;

				streamLinks = new Array();
				{% for stream in entity.stream_links %}
					var streamMap = new Map();
					streamMap.set('stream_id', '{{stream.stream_id}}');
					streamMap.set('stream_alias', '{{stream.stream_alias}}');
					streamMap.set('stream_value', '{{stream.stream_value}}');
					streamLinks.push(streamMap);
				{% endfor %}
				entityOBJ.setStreamLinks = streamLinks;
				
				var iconFeature = new ol.Feature({
					geometry: new ol.geom.Point(['{{entity.position_e}}', '{{entity.position_n}}']),
					name: '{{entity.entity_id}}',
					population: 4000,
					rainfall: 500,
				});
				iconFeature.setStyle(iconStyle);
				entityOBJ.setIconFeature = iconFeature;

				entityMap.set('{{entity.entity_id}}', entityOBJ);
			})(entityMap);
		{% endfor %}

		var vectorSource = new ol.source.Vector({
			features: entityMap.getIconFeatureList,
		});

		var vectorLayer = new ol.layer.Vector({
			source: vectorSource,
		});

		// Добавление кнопки скрытия панели со списком Entity
		var BtnShowSidePanel = /*@__PURE__*/(function (Control) {
			function BtnShowSidePanel(opt_options) {
				var options = opt_options || {};
			
				var btn_sidepanel = document.createElement('button');
				btn_sidepanel.innerHTML = '«'; // Alt + 0171 и Alt + 0187

				var element_sidepanel = document.createElement('div');
				element_sidepanel.className = 'btn-sidepanel-show ol-unselectable ol-control';
				element_sidepanel.appendChild(btn_sidepanel);
				element_sidepanel.title = 'Hide sidepanel';

				ol.control.Control.call(this, {
					element: element_sidepanel,
					target: options.target,
				});
					
				btn_sidepanel.addEventListener('click', function(){
					if (this.innerHTML == '«'){
						document.getElementById('sidepanel').hidden = true;
						splitter.refresh();
						map.updateSize();
						this.innerHTML = '»';
						element_sidepanel.title = 'Show sidepanel';
					} 
					else {
						//document.getElementById('widget').style.marginLeft = "300px";
						document.getElementById('sidepanel').hidden = false;
						splitter.refresh();
						map.updateSize();
						this.innerHTML = '«';
						element_sidepanel.title = 'Hide sidepanel';
					}
				}, false);
			}

			if (Control) BtnShowSidePanel.__proto__ = ol.control.Control;
			BtnShowSidePanel.prototype = Object.create( ol.control.Control && ol.control.Control.prototype );
			BtnShowSidePanel.prototype.constructor = BtnShowSidePanel;
			return BtnShowSidePanel;
		}(ol.control.Control));

		// Добавление кнопки сохранения настроек
		var BtnSaveSettings = /*@__PURE__*/(function (Control) {
			function BtnSaveSettings(opt_options) {
				var options = opt_options || {};
			
				var btn_save = document.createElement('button');
				btn_save.innerHTML = `
				<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" class="bi bi-save2" viewBox="0 0 16 16">
					<path d="M2 1a1 1 0 0 0-1 1v12a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1H9.5a1 1 0 0 0-1 1v4.5h2a.5.5 0 0 1 .354.854l-2.5 2.5a.5.5 0 0 1-.708 0l-2.5-2.5A.5.5 0 0 1 5.5 6.5h2V2a2 2 0 0 1 2-2H14a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V2a2 2 0 0 1 2-2h2.5a.5.5 0 0 1 0 1H2z"/>
				</svg>`;

				var element_save = document.createElement('div');
				element_save.title = 'Save(Shift+S)';
				element_save.className = 'btn-save-settings ol-unselectable ol-control';
				element_save.appendChild(btn_save);

				ol.control.Control.call(this, {
					element: element_save,
					target: options.target,
				});
					
				element_save.addEventListener('click', function(){
					saveUserSettings();
				}, false);
			}

			if (Control) BtnSaveSettings.__proto__ = ol.control.Control;
			BtnSaveSettings.prototype = Object.create( ol.control.Control && ol.control.Control.prototype );
			BtnSaveSettings.prototype.constructor = BtnSaveSettings;
			return BtnSaveSettings;
		}(ol.control.Control));

		// Выставление пользовательских настроек
		var settings;
		var position_e = parseFloat('{{position_e}}'.replace(",", "."));
		var position_n = parseFloat('{{position_n}}'.replace(",", "."));
		var zoom = parseFloat('{{zoom}}'.replace(",", "."));
		var settings_size_text = '{{settings_size_text}}';
		var settings_size_preview = '{{settings_size_preview}}';
		var settings_opacity_windows = parseFloat('{{settings_opacity_windows}}'.replace(",", "."));
		$.ajax({
			url: '{% url "get_settings" %}',
			method: 'post',
			dataType:'json',
			async: false,
			data: {
				csrfmiddlewaretoken: '{{ csrf_token }}',
				ids: `${entityMap.getIdList}`,
			},     
			success: function(data){
				settings = data;
			}
		});

		// Создание карты
	    var map = new ol.Map({
			controls: ol.control.defaults().extend([
				new ol.control.FullScreen({
					source: 'fullscreen',
				}),
				new BtnShowSidePanel(),
				new BtnSaveSettings(),
			]),
			target: 'map',
			layers: [
				new ol.layer.Tile({
					source: new ol.source.OSM({
						attributions: "",
					})
				}), 
				vectorLayer,
			],
			view: new ol.View({
				center: ol.proj.fromLonLat([0, 0]),
				zoom: 1
			})
	    });
		
		// Установка начального положения карты
		var view = map.getView();
		view.setCenter([position_e, position_n]);
		view.setZoom(zoom);

		// Инициализация счетчика z-Index'а окон подсказок 
		var zIndexPopupCount = 0;

		// Сохранение положения карты 
		map.on('moveend', function () {
			$('#fullscreen').css({'height':`${document.documentElement.clientHeight-70}px`});
			map.updateSize();
			zoom = view.getZoom();
			position_e = view.getCenter()[0];
			position_n = view.getCenter()[1];
		});

		// Заполнение контейнера Entity объектами окон параметров и превью 
		for(var [entity_id, value] of entityMap.entries()) {
			var popup = new ol.Overlay({
				element: document.getElementById('popup_' + entity_id),
				positioning: 'bottom-center',
				stopEvent: false,
				offset: [0, -15],
			});
			value.setPopup = popup;
			map.addOverlay(popup);
		}

		// Отрисовка панели с видеопотоками
		for(var [entity_id, value] of entityMap.entries()) {
			for(var stream of value.getStreamLinks) {
				$(document.getElementById('liststream')).append(`
					<div id="stream_${entity_id}_${stream.get('stream_id')}" style="padding: 5px; display:none;" class="list-group-item list-group-item-action">
						
						<div class="row">
							<div class="col-9">
								<h3>${value.getModel}</h3>
								<h5><i>${stream.get('stream_alias')}</i></h5>
							</div> 
							<div class="col-3" style="padding-right: 12px;">
								<div class="d-flex justify-content-end" style="padding-bottom: 3px;">
									<span id="close_stream_${entity_id}_${stream.get('stream_id')}" class="badge set-cursor settings-button stream-close">
										<svg xmlns="http://www.w3.org/2000/svg" width="10" height="10" fill="currentColor" class="bi bi-x-lg" viewBox="0 0 16 16">
											<path d="M1.293 1.293a1 1 0 0 1 1.414 0L8 6.586l5.293-5.293a1 1 0 1 1 1.414 1.414L9.414 8l5.293 5.293a1 1 0 0 1-1.414 1.414L8 9.414l-5.293 5.293a1 1 0 0 1-1.414-1.414L6.586 8 1.293 2.707a1 1 0 0 1 0-1.414z"/>
										</svg>
									</span>
								</div>
							</div>
						</div>
						<img src="${stream.get('stream_value')}" class="d-block w-100" alt="Нет видеопотоков">
					</div>
				`);
			}
		}
		
		// Функция показа окна с параметрами
		function showWindow (feature){
			var entityId = feature.get('name');
			var coordinates = feature.getGeometry().getCoordinates();
			var hdms = ol.coordinate.toStringHDMS(ol.proj.toLonLat(coordinates));
			var popup = entityMap.getPopupById(entityId);
			var element = popup.getElement();
			
			$(element).popover('dispose');
			popup.setPosition(coordinates);
			
			var flagSetListener = false; // флаг нужен чтобы избежать создание лишних обработчиков
			var params = entityMap.get(entityId).getParams; // array параметров entity
			var streamLinks = entityMap.get(entityId).getStreamLinks; // array видеопотоков entity
			var paramsContent = '';
			var streamLinksContent = '';
			var streamLinksIndicators = '';
			var streamLinksIndicatorsFull = '';

			// Формирование блока со списком параметров
			for(var param of params) {
				var hiddenParamList = settings[entityId]['hidden_params_ids'];
				if(hiddenParamList.indexOf(param.get('params_id')) >= 0){
					paramsContent+= `<p id="p_sw_${param.get('params_id')}_${entityId}" class="m-0" style="display:none;">${param.get('params_alias')}: ${param.get('params_value')}</p>`;
				}	
				else{
					paramsContent+= `<p id="p_sw_${param.get('params_id')}_${entityId}" class="m-0">${param.get('params_alias')}: ${param.get('params_value')}</p>`;
				}				
			}
			
			// Формирование блока отображения видеопотока
			var countCarousel = 0;
			for(var stream of streamLinks) {
				if(!countCarousel){
					streamLinksContent+= `
						<div id="${stream.get('stream_id')}" class="carousel-item active">
							<div class="title-prd">
								<p class="title-prt">${stream.get('stream_alias')}</p>
							</div>
							<img src=${stream.get('stream_value')} class="d-block w-100" alt="Видео не найдено" onerror="this.src ='{% static "media/videostream.png" %}'">
						</div>
					`;
					streamLinksIndicators+=`
						<button type="button" style="background-color: green;" data-bs-target="#carousel_${entityId}" data-bs-slide-to="${countCarousel}" class="active" aria-current="true" aria-label="Slide ${countCarousel+1}"></button>
					`;
					streamLinksIndicatorsFull+=`
						<button type="button" data-bs-target="#full_carousel_${entityId}" data-bs-slide-to="${countCarousel}" class="active" aria-current="true" aria-label="Slide ${countCarousel+1}"></button>
					`;
				}
				else{
					streamLinksContent+= `
						<div id="${stream.get('stream_id')}" class="carousel-item">
							<div class="title-prd">
								<p class="title-prt">${stream.get('stream_alias')}</p>
							</div>
							<img src=${stream.get('stream_value')} class="d-block w-100" alt="Видео не найдено" onerror="this.src ='{% static "media/videostream.png" %}'">
						</div>
					`;
					streamLinksIndicators+=`
						<button type="button" style="background-color: green;" data-bs-target="#carousel_${entityId}" data-bs-slide-to="${countCarousel}" aria-current="true" aria-label="Slide ${countCarousel+1}"></button>
					`;
					streamLinksIndicatorsFull+=`
						<button type="button" data-bs-target="#full_carousel_${entityId}" data-bs-slide-to="${countCarousel}" aria-current="true" aria-label="Slide ${countCarousel+1}"></button>
					`;
				}
				
				countCarousel+=1;
			}
			
			// Если нет видеопотоков
			if(!countCarousel){
				streamLinksContent+= `
					<div class="carousel-item active">
						<img src="{% static "media/videostream.png" %}" class="d-block w-100" alt="Нет видеопотоков">
					</div>
				`;
			}

			// Инициализация окна над указателем.
			// Выполняем заполнение контентом только при событии появления окна
			$(element).popover({
				container: element,
				placement: 'top',
				animation: false,
				html: true,
				title : '<div></div>',
				content:'',

			}).on('shown.bs.popover', function (eventShown) {
				if(!flagSetListener){	
					$(element).find('.popover-body').html(
						`<div class="params p-1">
							<div class="params-lines">
								${paramsContent}
							</div>
						</div>
						<div class="params-btns">
							<span id="span_close_min" class="badge set-cursor settings-button close-button my-1 mx-1">x</span>
							<span id="span_more" class="badge set-cursor settings-button more-button mb-1 mx-1">»</span>
						</div>
						<div class="more-settings p-2">
							<!--<img src={% static "media/videostream.png" %} width="150px">-->
							<div id="carousel_${entityId}" class="carousel slide" style="padding-bottom: 20px;" data-bs-ride="carousel" data-bs-interval="false">								  	
								<div class="carousel-inner">
									${streamLinksContent}
								</div>
								<div class="carousel-indicators carousel-preview">
									${streamLinksIndicators}
								</div>
								<!--<button class="carousel-control-prev" type="button" data-bs-target="#carousel_${entityId}" data-bs-slide="prev">
									<span class="carousel-control-prev-icon" aria-hidden="true"></span>
									<span class="visually-hidden">Previous</span>
								</button>
								<button class="carousel-control-next" type="button" data-bs-target="#carousel_${entityId}" data-bs-slide="next">
									<span class="carousel-control-next-icon" aria-hidden="true"></span>
									<span class="visually-hidden">Next</span>
								</button>-->
							</div>
							<!--<div class="d-flex justify-content-end mt-1">
								<span id="span_less" class="badge set-cursor settings-button">«</span>
								<span id="span_video" class="badge mx-1 set-cursor settings-button">Видео</span>
								<span id="span_settings" class="badge set-cursor settings-button">Настройки</span>
							</div>-->
						</div>`
					);

					$(element).find('.popover-header').html(
						`<div class="row">
							<div class="col-7">
								<span>${entityMap.getModelById(entityId)}</span>
							</div> 
							<div class="col-5" style="padding-right: 5px;">
								<div class="d-flex justify-content-end" style="padding-bottom: 5px;">									
									<span id="span_settings" class="badge set-cursor settings-button">
										<svg xmlns="http://www.w3.org/2000/svg" width="10" height="10" fill="currentColor" class="bi bi-gear" viewBox="0 0 16 16">
											<path d="M8 4.754a3.246 3.246 0 1 0 0 6.492 3.246 3.246 0 0 0 0-6.492zM5.754 8a2.246 2.246 0 1 1 4.492 0 2.246 2.246 0 0 1-4.492 0z"></path>
											<path d="M9.796 1.343c-.527-1.79-3.065-1.79-3.592 0l-.094.319a.873.873 0 0 1-1.255.52l-.292-.16c-1.64-.892-3.433.902-2.54 2.541l.159.292a.873.873 0 0 1-.52 1.255l-.319.094c-1.79.527-1.79 3.065 0 3.592l.319.094a.873.873 0 0 1 .52 1.255l-.16.292c-.892 1.64.901 3.434 2.541 2.54l.292-.159a.873.873 0 0 1 1.255.52l.094.319c.527 1.79 3.065 1.79 3.592 0l.094-.319a.873.873 0 0 1 1.255-.52l.292.16c1.64.893 3.434-.902 2.54-2.541l-.159-.292a.873.873 0 0 1 .52-1.255l.319-.094c1.79-.527 1.79-3.065 0-3.592l-.319-.094a.873.873 0 0 1-.52-1.255l.16-.292c.893-1.64-.902-3.433-2.541-2.54l-.292.159a.873.873 0 0 1-1.255-.52l-.094-.319zm-2.633.283c.246-.835 1.428-.835 1.674 0l.094.319a1.873 1.873 0 0 0 2.693 1.115l.291-.16c.764-.415 1.6.42 1.184 1.185l-.159.292a1.873 1.873 0 0 0 1.116 2.692l.318.094c.835.246.835 1.428 0 1.674l-.319.094a1.873 1.873 0 0 0-1.115 2.693l.16.291c.415.764-.42 1.6-1.185 1.184l-.291-.159a1.873 1.873 0 0 0-2.693 1.116l-.094.318c-.246.835-1.428.835-1.674 0l-.094-.319a1.873 1.873 0 0 0-2.692-1.115l-.292.16c-.764.415-1.6-.42-1.184-1.185l.159-.291A1.873 1.873 0 0 0 1.945 8.93l-.319-.094c-.835-.246-.835-1.428 0-1.674l.319-.094A1.873 1.873 0 0 0 3.06 4.377l-.16-.292c-.415-.764.42-1.6 1.185-1.184l.292.159a1.873 1.873 0 0 0 2.692-1.115l.094-.319z"></path>
										</svg>
									</span>
									<span id="span_less" class="badge set-cursor settings-button ms-1">
										<svg xmlns="http://www.w3.org/2000/svg" width="10" height="10" fill="currentColor" class="bi bi-dash-lg" viewBox="0 0 16 16">
											<path d="M0 8a1 1 0 0 1 1-1h14a1 1 0 1 1 0 2H1a1 1 0 0 1-1-1z"/>
										</svg>
									</span>
									<span id="span_close" class="badge set-cursor settings-button ms-1">
										<svg xmlns="http://www.w3.org/2000/svg" width="10" height="10" fill="currentColor" class="bi bi-x-lg" viewBox="0 0 16 16">
											<path d="M1.293 1.293a1 1 0 0 1 1.414 0L8 6.586l5.293-5.293a1 1 0 1 1 1.414 1.414L9.414 8l5.293 5.293a1 1 0 0 1-1.414 1.414L8 9.414l-5.293 5.293a1 1 0 0 1-1.414-1.414L6.586 8 1.293 2.707a1 1 0 0 1 0-1.414z"/>
										</svg>
									</span>
								</div>
							</div>
						</div>`
					);

					// Применение глобыльных настроек
					var rng1 = document.getElementById('customRange1');
					var rng2 = document.getElementById('customRange2');
					var rng3 = document.getElementById('customRange3');
					$('.params-lines').css({'font-size': rng1.value +'px'});
					$('.carousel-inner').css({'width': rng2.value +'px'});
					$('.popover').css({'opacity': rng3.value});

					// Обработка закрытия окна
					/*$(element).find('#span_close').on('click', function(e) {
						$(element).popover('dispose');
					});*/

					// Обработка нажатия на кнопку "Видео" - подробный видеопоток от Entity
					$(element).find('#span_video').on('click', function(e) {
						var videoModal = new bootstrap.Modal(document.getElementById('videoModal'), {
							keyboard: false
						});
						document.getElementById('videoModalTitle').innerHTML = `Видеопоток ${entityMap.getModelById(entityId)}`;
						document.getElementById('videoModalContent').innerHTML = `
							<div id="full_carousel_${entityId}" class="carousel slide" data-bs-ride="carousel" data-bs-interval="false">
								<div class="carousel-indicators">
									${streamLinksIndicatorsFull}
								</div>
								<div class="carousel-inner">
									${streamLinksContent}
								</div>
								<button class="carousel-control-prev" type="button" data-bs-target="#full_carousel_${entityId}" data-bs-slide="prev">
									<span class="carousel-control-prev-icon" aria-hidden="true"></span>
									<span class="visually-hidden">Previous</span>
								</button>
								<button class="carousel-control-next" type="button" data-bs-target="#full_carousel_${entityId}" data-bs-slide="next">
									<span class="carousel-control-next-icon" aria-hidden="true"></span>
									<span class="visually-hidden">Next</span>
								</button>
							</div>
						`;
						videoModal.show();
					});

					// Обработка нажатия на кнопку "Настройки" - локальные настройки Entity
					$(element).find('#span_settings').on('click', function(e) {
						var settingsModal = new bootstrap.Modal(document.getElementById('settingsModal'), {
							keyboard: false
						});
						document.getElementById('settingsModalTitle').innerHTML = `Параметры ${entityMap.getModelById(entityId)}`;
						
						var settingsContent = '';
						for(var param of params) {
							var isCheck = 'checked';
							var hiddenParamList = settings[entityId]['hidden_params_ids'];
							if(hiddenParamList.indexOf(param.get('params_id')) >= 0){
								isCheck = "";
							}
							
							settingsContent+= `
								<div class="row">
									<div class="col">
										<label for="sw_${param.get('params_id')}_${entityId}" class="form-label">${param.get('params_alias')}</label>
									</div>
									<div class="col-2 gsettings-col">
										<div class="form-check form-switch">
											<input id="sw_${param.get('params_id')}_${entityId}" class="form-check-input" type="checkbox" ${isCheck}>
										</div>
									</div>
								</div>
							`;								
						}
						document.getElementById('settingsModalContent').innerHTML = settingsContent;
						
						for(var param of params) {
							var swParam = document.getElementById(`sw_${param.get('params_id')}_${entityId}`);
							swParam.addEventListener("change", function () {
								par = this.id.split('_')[1];
								if (this.checked){
									settings[entityId]['hidden_params_ids'].pop(par);
									$(`#p_${this.id}`).css({'display': ''});
								}
								else{
									settings[entityId]['hidden_params_ids'].push(par);
									$(`#p_${this.id}`).css({'display': 'none'});
								}
							}, false);
							
						}						
						settingsModal.show();
					});

					// Обработка нажатия на кнопку "»" - показать превью
					$(element).find('#span_more').on('click', function(e) {
						settings_block = $(element).find('.more-settings');
						header_block = $(element).find('.popover-header');
						button_more = $(element).find('#span_more');
						button_close = $(element).find('#span_close_min');
						if(settings_block.css('display')=='none'){
							settings_block.css({'display':'block'});
							header_block.css({'display':'block'});
							button_more.css({'display':'none'});
							button_close.css({'display':'none'});
						}
						else{
							settings_block.css({'display':'none'});
							header_block.css({'display':'none'});
							button_more.css({'display':'inline-flex'});
							button_close.css({'display':'inline-flex'});
						}
						settings[entityId]['shown_preview'] = true;
					});

					// Обработка нажатия на кнопку "-" - скрыть превью
					$(element).find('#span_less').on('click', function(e) {
						settings_block = $(element).find('.more-settings');
						header_block = $(element).find('.popover-header');
						button_more = $(element).find('#span_more');
						button_close = $(element).find('#span_close_min');
						if(settings_block.css('display')=='block'){
							settings_block.css({'display':'none'});
							header_block.css({'display':'none'});
							button_more.css({'display':'inline-flex'});
							button_close.css({'display':'inline-flex'});
						}
						else{
							settings_block.css({'display':'block'});
							header_block.css({'display':'block'});
							button_more.css({'display':'none'});
							button_close.css({'display':'none'});
						}
						settings[entityId]['shown_preview'] = false;
						showWindow(feature);
					});

					// Обработка закрытия окна
					$(element).find('#span_close').on('click', function(e) {
						$(element).popover('dispose');
						// Сохранение видимости окна в настройки
						settings[entityId]['shown_param'] = false;
						settings[entityId]['shown_preview'] = false;
					});
					$(element).find('#span_close_min').on('click', function(e) {
						$(element).popover('dispose');
						// Сохранение видимости окна в настройки
						settings[entityId]['shown_param'] = false;
						settings[entityId]['shown_preview'] = false;
					});

					// Контекстное окно над видеопотоком
					$(function() {
						var x = 0;
						$.contextMenu({
							selector: `#carousel_${entityId} .carousel-item.active`, 
							build: function($triggerElement, e){
								var chId = entityId + '_' + $(`#carousel_${entityId} .carousel-item.active`).attr('id'); 
								if (!document.getElementById(chId).checked){
									var textShow = "Показать в списке";
									var iconShow = 'add';
								}
								else{
									var textShow = "Удалить из списка";
									var iconShow = 'delete';
								}
								return {
									callback: function(key, options) {
										$(`#${chId}`).click();
									},
									items: {
										"show": {name: textShow, icon: iconShow},
									}
								};
							}
						}); 
					});

					flagSetListener=true;
				}

			}).on('hide.bs.popover', function (eventShown) {					
				$(element).popover('toggle');
			});

			zIndexPopupCount +=1;
			$(element).parent().css({"z-index":zIndexPopupCount});
			$(element).popover('show');

			// При нажатии на окно, оно появляется поверх остальных окон
			$(element).on('click', function (eventShown) {	
				zIndexPopupCount +=1;
				$(element).parent().css({"z-index":zIndexPopupCount});	
			});

			// Сохранение видимости окна в настройки
			settings[entityId]['shown_param'] = true;
		}

		// Нажатие на иконку Entity
		map.on('click', function (evt) {
			// Содержимое окон параметров и превью заполняется только при появлении этого окна
			// Костыли, написанные в этом блоке, позволяют динамически формировать содержимое этих окон
			// Не пытайтесь разобраться и понять неэффективные методы, используемые в этом блоке
			// Лучше перепишите по-новой, либо используйте доступный функционал

			// Суть ниженаписанного (функции showWindow) состоит в следующем:
			// Сначала динамически формируются блоки контекста окна, в зависими от значения переменных
			// Эти блоки включаются в другие, более общие блоки
			// Затем, по идентификатору указателя(иконки) по которому произошло нажатие, контекст появляется в окнах над ними
			
			var feature = map.forEachFeatureAtPixel(evt.pixel, function (feature) {
				return feature;
			});
			if (feature) {
				showWindow(feature);
			}
		});

		// Изменение курсора при наведении на указатель Entity
		map.on('pointermove', function (evt) {
			var hit = this.forEachFeatureAtPixel(evt.pixel, function(hit, layer) {
				return hit;
			}); 

			if (hit) {
				this.getTargetElement().style.cursor = 'pointer';

				var entityId = hit.get('name');
				var entityModel = entityMap.getModelById(entityId);
				var entityNumber = entityMap.getNumberById(entityId);
				$('#hintmap').css({'display':'block'});
				$('#hintmap p').html(`<b>${entityModel}</b> <i>(${entityNumber})</i>`);
			} else {
				this.getTargetElement().style.cursor = '';
				$('#hintmap p').html('');
				$('#hintmap').css({'display':'none'});
			}
		});

		// Функция отрисовки фокуса (круга) на указателе Entity
		function drowCircle(feature) {
			var start = new Date().getTime();
			var listenerKey = vectorLayer.on('postrender', animate);
			function animate(event) {
				var vectorContext = ol.render.getVectorContext(event);
				var frameState = event.frameState;
				var flashGeom = feature.get('geometry');
				var elapsed = frameState.time - start;
				var duration = 1000;
				var elapsedRatio = elapsed / duration;
				// radius will be 5 at start and 30 at end.
				var radius = ol.easing.easeOut(elapsedRatio) * 20 + 5;
				var opacity = ol.easing.easeOut(1 - elapsedRatio);

				var style = new ol.style.Style({
				image: new ol.style.Circle({
					radius: radius,
					stroke: new ol.style.Stroke({
					color: 'rgba(255, 0, 0, ' + opacity + ')',
					width: 0.25 + opacity,
					}),
				}),
				});

				vectorContext.setStyle(style);
				vectorContext.drawGeometry(flashGeom);
				if (elapsed > duration) {
				ol.Observable.unByKey(listenerKey);
				return;
				}
				// tell OpenLayers to continue postrender animation
				map.render();
			}
		}

		// Обработка событий фокуса и показа/скрытия указателей Entity
		var view_button_show = document.querySelectorAll(".show");
		var view_switch = document.querySelectorAll(".view-object");
		for (var i = 0; i < view_button_show.length; i++) {
			view_button_show[i].addEventListener("click", function () {
				var car_id = this.getAttribute('id');
				let featureIcon = entityMap.getIconFeatureById(car_id);
				let p = featureIcon.get('geometry').getFirstCoordinate();
				view.setCenter([parseFloat(p[0]), parseFloat(p[1])]);
				drowCircle(featureIcon);
				let sws = document.getElementsByClassName('view-object');
				for(var j = 0; j < sws.length; j++){
					if (sws[j].getAttribute('id') == car_id){
						if(!sws[j].checked){
							sws[j].click();
						}
						break;
					}
				}
			}, false);

			view_switch[i].addEventListener("change", function () {
				var car_id = this.getAttribute('id');
				let featureIcon = entityMap.getIconFeatureById(car_id);
				if (!this.checked){
					featureIcon.setStyle(new ol.style.Style({}));
					var p = entityMap.getPopupById(car_id).getElement();
					$(p).popover('dispose');
					settings[car_id]['visibility'] = false;
					settings[car_id]['shown_param'] = false;
					settings[car_id]['shown_preview'] = false;
				} else {
					featureIcon.setStyle(iconStyle);
					settings[car_id]['visibility'] = true;
				}
			}, false);
		}

		// Обработка события показа(скрытия) всех указателей entity
		var view_switch_all = document.getElementById("all_show");
		view_switch_all.addEventListener("change", function () {
			
			for(var j = 0; j < view_button_show.length; j++){
				if (view_switch[j].checked != this.checked){
					view_switch[j].click();
				}
			}
			for(var setting in settings){
				if(this.checked){
					settings[setting]['visibility'] = true;
				}
				else{
					settings[setting]['visibility'] = false;
				}
			}
		}, false);

		// Обработка события показа(скрытия) всех окон
		var view_switch_all = document.getElementById("all_show_param");
		view_switch_all.addEventListener("change", function () {
			if (this.checked){
				for(var [auto_id, value] of entityMap.entries()) {
					var swElement = document.getElementsByClassName('view-object')[auto_id];
					if (swElement.checked){
						showWindow(value.getIconFeature);
					}
				}
			}
			else{
				for(var [auto_id, value] of entityMap.entries()) {
					var element = value.getPopup.getElement();
					$(element).popover('dispose');
				}
			}

			for(var setting in settings){
				if(this.checked){
					settings[setting]['shown_param'] = true;
				}
				else{
					settings[setting]['shown_param'] = false;
					settings[setting]['shown_preview'] = false;
				}
			}
		}, false);

		// Обработка показа(скрытия) видеопотоков
		for(var [entity_id, value] of entityMap.entries()) {
			for(var stream of value.getStreamLinks) {
				$(`#${entity_id}_${stream.get('stream_id')}`).on("change", function () {
					if (this.checked){
						$(`#stream_${this.id}`).css({"display":"block"});
						if(settings[this.id.split('_')[0]]['shown_stream_ids'].indexOf(this.id.split('_')[1])==-1){
							settings[this.id.split('_')[0]]['shown_stream_ids'].push(this.id.split('_')[1]);
						}
					}
					else{
						$(`#stream_${this.id}`).css({"display":"none"});
						settings[this.id.split('_')[0]]['shown_stream_ids'].pop(this.id.split('_')[1]);
					}
				});
			}
		}

		// Обработка скрытия видеопотоков на крестик
		for(var [entity_id, value] of entityMap.entries()) {
			for(var stream of value.getStreamLinks) {
				$(`#close_stream_${entity_id}_${stream.get('stream_id')}`).on("click", function (entity_id) {
					$(`#${this.id.slice(13)}`).click();//херня
				});
			}
		}

		// Обработка нажатия на кнопку "Сброс"
		$(document).ready(function() {
			$("#btn_reset").click(function(){
				saveUserSettings(reset=true);
				location.reload();
			}); 
		});


		// Обработка ползунков настроек
		function dragRange1(){
			var rng = document.getElementById('customRange1');
			$('#contentRange1').html(rng.value +'px');
			$('.params-lines').css({'font-size': rng.value +'px'});
			settings_size_text =  rng.value;
		}
		function dragRange2(){
			var rng = document.getElementById('customRange2');
			$('#contentRange2').html(rng.value +'px');
			$('.carousel-inner').css({'width': rng.value +'px'});
			settings_size_preview = rng.value;
		}
		function dragRange3(){
			var rng = document.getElementById('customRange3');
			$('#contentRange3').html(rng.value * 100 +'%');
			$('.popover').css({'opacity': rng.value});
			settings_opacity_windows = rng.value;
		}

		var streamList = $('#objectstreamlist');
		var stopResize = 220; //px
		var sensor = new ResizeSensor(streamList, function(){
			if(streamList.width()<stopResize){
				$('#objectstreamlist h3').css({'font-size':streamList.width()/100*7});
				$('#objectstreamlist h5').css({'font-size':streamList.width()/100*5});
				$('.stream-close').css({'padding':streamList.width()/100*1 +'px'});
			}
			else{
				$('#objectstreamlist h3').css({'font-size':stopResize/100*7});
				$('#objectstreamlist h5').css({'font-size':stopResize/100*5});
				$('.stream-close').css({'padding':'6px'});
			}
		});

		window.onload = function() {
			// Считывание из настроек видимость каждого Entity и его окон
			for(var j = 0; j < view_switch.length; j++){
				var visibility = settings[view_switch[j].id]['visibility'];
				var shown_param = settings[view_switch[j].id]['shown_param'];
				var shown_preview = settings[view_switch[j].id]['shown_preview'];
				if(!visibility){
					view_switch[j].click();
					continue;
				}	
				if(shown_param){
					showWindow(entityMap.getIconFeatureById(view_switch[j].id));
					if(shown_preview){
						$(`#popup_${view_switch[j].id} #span_more`).click();
					}
				}
			}

			// Считывание из настроек видимость видеопотоков
			for(var [entity_id, value] of entityMap.entries()) {
				var shownStreamList = settings[entity_id]['shown_stream_ids'];
				for(var stream of value.getStreamLinks) {
					if(shownStreamList.indexOf(stream.get('stream_id')) >= 0){
						$('#list').find(`#${entity_id}_${stream.get('stream_id')}`).click();
					}
				}
			}
		};

		/*window.onunload = function(evt) {
			var analyticsData = new FormData();
			analyticsData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
			analyticsData.append('settings', JSON.stringify(settings));
			analyticsData.append('reset', false);
			analyticsData.append('global_settings', 
				JSON.stringify({
					zoom: zoom,
					position_e: position_e,
					position_n: position_n,
					s_size_text: parseFloat(settings_size_text),
					s_size_preview: parseFloat(settings_size_preview),
					s_opacity_windows: parseFloat(settings_opacity_windows),
				})
			);
			navigator.sendBeacon('{% url "set_settings" %}', analyticsData);
		};*/

		function saveUserSettings(reset=false){
			$.ajax({
				url: '{% url "set_settings" %}',
				method: 'post',
				dataType:'json',
				async:true,
				data: {
					csrfmiddlewaretoken: '{{ csrf_token }}',
					settings:JSON.stringify(settings),
					reset: reset,
					global_settings:JSON.stringify({
						zoom: zoom,
						position_e: position_e,
						position_n: position_n,
						s_size_text: parseFloat(settings_size_text),
						s_size_preview: parseFloat(settings_size_preview),
						s_opacity_windows: parseFloat(settings_opacity_windows),
					}),
				},     
				success: function(data){ 
					console.log(data);
				}
			});
		}

		function runOnKeys(func, ...codes) {
			let pressed = new Set();
			document.addEventListener('keydown', function(event) {
				pressed.add(event.code);
				for (let code of codes) { // все ли клавиши из набора нажаты?
					if (!pressed.has(code)) {
						return;
					}
				}
				pressed.clear();
				func();
			});
			document.addEventListener('keyup', function(event) {
				pressed.delete(event.code);
			});
		}
		runOnKeys(
			() => saveUserSettings(),
			"ShiftLeft",
			"KeyS"
		);

    </script>
	
	<script>
		// Получаем новые данные с сервера каждые N миллисекунд
		/*setInterval(function(){
			$.ajax({
				url: '{% url "get_new_data" %}',
				method: 'post',
				dataType:'json',
				async:false,
				data: {
					csrfmiddlewaretoken: '{{ csrf_token }}',
				},     
				success: function(data){ 
					for(var e of data['entity_list']){
						en_id = e['entity_id']
						p_e = e['position_e'].replace(',','.');
						p_n = e['position_n'].replace(',','.');
						params = e['params']
						try{
							if(entityMap.getIdList.indexOf(en_id) >= 0){
								for(var p of params){
									pop = entityMap.getPopupById(en_id).getElement();
									$(pop).find(`#p_sw_${p['params_id']}_${en_id}`).html(`
										${p['params_alias']}: ${p['params_value']}
									`);
								}
							}
						}
						catch{}
						try{
							if(p_e != undefined || p_n != undefined ){
								entityMap.getIconFeatureById(en_id).set('geometry', new ol.geom.Point([p_e, p_n]));
								var coor = entityMap.getIconFeatureById(en_id).getGeometry().getCoordinates();
								entityMap.getPopupById(en_id).setPosition(coor);
							}
						}
						catch{}
					}
				}
			});
		},2000);*/

		// Cохраняем настройки каждые N миллисекунд
		/*setInterval(function(){
			saveUserSettings();
		},30000);*/

	</script>
{% endblock %}