{% extends 'index.html' %}
{% load static %}
{% load mathfilters %}
{% load replace %}

{% block nav_title %}
    <h4 align="center">Карта </h4>
{% endblock %}

{% block top_nav_buttons_left %}
    <li class="nav-item px-3">
        {% url 'index_url' as index_page_url %}
        <a class="nav-link btn-secondary" href="{{index_page_url}}">На главную</a>
    </li>
{% endblock %}

{% block css %}
	<!--   jQuery и OpenLayers можно скачать на официальных сайтах и использовать оффлайн -->
	<!-- 		  jQuery      - https://jquery.com/download/ -->
	<!-- 		OpenLayers    - https://openlayers.org/download/ -->

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/openlayers/openlayers.github.io@master/en/v6.5.0/css/ol.css" type="text/css">
    <script type="text/javascript" src="https://cdn.jsdelivr.net/gh/openlayers/openlayers.github.io@master/en/v6.5.0/build/ol.js"></script>
	<script src="https://unpkg.com/elm-pep"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/list.js/1.5.0/list.min.js"></script>
	<script type="text/javascript" src="{% static "jquery.cookie.js" %}"></script>

	<script src="{% static "jquery.splitter.js" %}"></script>
    <link href="{% static "jquery.splitter.css" %}" rel="stylesheet"/>	
	<link rel="stylesheet" href="{% static "mystyles.css" %}">
	
{% endblock %}

{% block content %}
	<div id="fullscreen" class="fullscreen">
    	
		<!-- Разметка окон с параметрами и превью -->
		{% for auto_id, value in objects.items %}
			<div style="display: none;">
				<div id="popup_{{auto_id}}" style="position:absolute;">
				</div>
			</div>
		{% endfor %}
	
		<!-- Разметка панели списка отображаемых объектов -->
		<div class="sidepanel" id="sidepanel">
			<div id="objectslist" class="list-group" style="height:100%; width: 300px;">
				<div class="overflow-auto p-1" style="height:100%">
					<ul id="list" class="list">
						{% for auto_id, value in objects.items %}
							<a href="#" id="{{auto_id}}" class="list-group-item list-group-item-action">
								<div class="d-flex w-100 justify-content-between">
									<h5 class="mb-1 model">{{value.model}}</h5>
									<small class="text-muted">
										<div class="form-check form-switch">
											<span id="{{auto_id}}" class="badge bg-primary show">Show</span>
											<input id="{{auto_id}}" class="form-check-input view-object" type="checkbox" checked>
										</div>
									</small>
								</div>
								<p class="mb-1 number">Номер: <i>{{value.number}}</i></p>
								<!-- <small class="text-muted">E:{{value.position_e}} N:{{value.position_n}}</small> -->
							</a>
						{% endfor %}
					</ul>
				</div>
				<div class="container">
					<div class="row align-items-center">
						<div class="col-8">
							<input class="search" placeholder="Поиск"/>
						</div>
						<div class="col-4">
							<i class="bi bi-gear"></i>
							<button type="button" class="btn btn-outline-secondary btn-global-settings" data-bs-toggle="modal" data-bs-target="#globalSettingsModal">
								<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-gear" viewBox="0 0 16 16">
									<path d="M8 4.754a3.246 3.246 0 1 0 0 6.492 3.246 3.246 0 0 0 0-6.492zM5.754 8a2.246 2.246 0 1 1 4.492 0 2.246 2.246 0 0 1-4.492 0z"/>
									<path d="M9.796 1.343c-.527-1.79-3.065-1.79-3.592 0l-.094.319a.873.873 0 0 1-1.255.52l-.292-.16c-1.64-.892-3.433.902-2.54 2.541l.159.292a.873.873 0 0 1-.52 1.255l-.319.094c-1.79.527-1.79 3.065 0 3.592l.319.094a.873.873 0 0 1 .52 1.255l-.16.292c-.892 1.64.901 3.434 2.541 2.54l.292-.159a.873.873 0 0 1 1.255.52l.094.319c.527 1.79 3.065 1.79 3.592 0l.094-.319a.873.873 0 0 1 1.255-.52l.292.16c1.64.893 3.434-.902 2.54-2.541l-.159-.292a.873.873 0 0 1 .52-1.255l.319-.094c1.79-.527 1.79-3.065 0-3.592l-.319-.094a.873.873 0 0 1-.52-1.255l.16-.292c.893-1.64-.902-3.433-2.541-2.54l-.292.159a.873.873 0 0 1-1.255-.52l-.094-.319zm-2.633.283c.246-.835 1.428-.835 1.674 0l.094.319a1.873 1.873 0 0 0 2.693 1.115l.291-.16c.764-.415 1.6.42 1.184 1.185l-.159.292a1.873 1.873 0 0 0 1.116 2.692l.318.094c.835.246.835 1.428 0 1.674l-.319.094a1.873 1.873 0 0 0-1.115 2.693l.16.291c.415.764-.42 1.6-1.185 1.184l-.291-.159a1.873 1.873 0 0 0-2.693 1.116l-.094.318c-.246.835-1.428.835-1.674 0l-.094-.319a1.873 1.873 0 0 0-2.692-1.115l-.292.16c-.764.415-1.6-.42-1.184-1.185l.159-.291A1.873 1.873 0 0 0 1.945 8.93l-.319-.094c-.835-.246-.835-1.428 0-1.674l.319-.094A1.873 1.873 0 0 0 3.06 4.377l-.16-.292c-.415-.764.42-1.6 1.185-1.184l.292.159a1.873 1.873 0 0 0 2.692-1.115l.094-.319z"/>
								</svg>
								<span class="visually-hidden">Button</span>
							</button>
						</div>
					</div>
				</div>
			</div>
		</div>

		<div id="widget" style="display: flex; height:100%; width:100%;">
			<!-- Разметка карты -->
			<div id="map" class="map"></div>

			<div class="streampanel">
				<div id="objectstreamlist" class="list-group" style="height:100%;">
					<div class="overflow-auto p-1" style="height:100%">
						<ul id="liststream" class="list">
							<!--<a href="#" id="1" class="list-group-item list-group-item-action">
								<img src="{% static "videostream.png" %}" class="d-block w-100" alt="Нет видеопотоков">
							</a>
							<a href="#" id="1" class="list-group-item list-group-item-action">
								<img src="{% static "videostream.png" %}" class="d-block w-100" alt="Нет видеопотоков">
							</a>
							<a href="#" id="1" class="list-group-item list-group-item-action">
								<img src="{% static "videostream.png" %}" class="d-block w-100" alt="Нет видеопотоков">
							</a>
							<a href="#" id="1" class="list-group-item list-group-item-action">
								<img src="{% static "videostream.png" %}" class="d-block w-100" alt="Нет видеопотоков">
							</a>-->
						</ul>
					</div>
				</div>
			</div>
		</div>

		<!-- Модальное окно с подробным отображением видеопотока -->
		<div class="modal fade" id="videoModal" tabindex="-1" aria-labelledby="videoModalTitle" aria-hidden="true">
			<div class="modal-dialog modal-dialog-centered">
				<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="videoModalTitle">Автомобиль</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
				</div>
				<div class="modal-body">
					<div id="videoModalContent"></div>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
				</div>
				</div>
			</div>
		</div>

		<!-- Модальное окно с настройками отбражаемых объектов -->
		<div class="modal fade" id="settingsModal" tabindex="-1" aria-labelledby="settingsModalTitle" aria-hidden="true">
			<div class="modal-dialog modal-dialog-centered">
				<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="settingsModalTitle">Автомобиль</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
				</div>
				<div class="modal-body">
					<div id="settingsModalContent"></div>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
				</div>
				</div>
			</div>
		</div>

		<!-- Модальное окно глобальных настроек -->
		<div class="modal fade" id="globalSettingsModal" tabindex="-1" aria-labelledby="globalSettingsModalTitle" aria-hidden="true">
			<div class="modal-dialog modal-dialog-centered">
				<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="globalSettingsModalTitle">Общие настройки</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
				</div>
				<div class="modal-body">
					<div id="globalSettingsModalContent" class="container">
						<div class="row gsettings-row">
							<div class="col-4">
								<label for="customRange1" class="form-label">Масштаб текста списка датчиков</label>
							</div>
							<div class="col gsettings-col">
								<input type="range" class="form-control-range gsettings-range" min="9" max="20" step="1.0" value="{{settings_size_text}}" id="customRange1" oninput="dragRange1()">
							</div>
							<div class="col-2 gsettings-col">
								<p id="contentRange1" class="gsettings-val">{{settings_size_text}}px</p>
							</div>
						</div>
						<div class="row gsettings-row">
							<div class="col-4">
								<label for="customRange2" class="form-label">Масштаб превью видеопотока</label>
							</div>
							<div class="col gsettings-col">
								<input type="range" class="form-control-range gsettings-range" min="150" max="500" step="10.0" value="{{settings_size_preview}}" id="customRange2" oninput="dragRange2()">
							</div>
							<div class="col-2 gsettings-col">
								<p id="contentRange2" class="gsettings-val">{{settings_size_preview}}px</p>
							</div>							
						</div>
						<div class="row gsettings-row">
							<div class="col-4">
								<label for="customRange3" class="form-label">Прозрачность окон указателей</label>
							</div>
							<div class="col gsettings-col">
								<input type="range" class="form-control-range gsettings-range" min="0.3" max="1.0" step="0.1" value="{{settings_opacity_windows|replace}}" id="customRange3" oninput="dragRange3()">
							</div>
							<div class="col-2 gsettings-col">
								<p id="contentRange3" class="gsettings-val">{{settings_opacity_windows|mul:100|add:0}}%</p>
							</div>							
						</div>
						<div class="row">
							<div class="col">
								<label for="all_show" class="form-label">Показать (скрыть) все указатели</label>
							</div>
							<div class="col-2 gsettings-col">
								<div class="form-check form-switch">
									<input id="all_show" class="form-check-input" type="checkbox" checked>
								</div>
							</div>
						</div>
						<div class="row">
							<div class="col">
								<label for="all_show_param" class="form-label">Показать (скрыть) все окна с параметрами</label>
							</div>
							<div class="col-2 gsettings-col">
								<div class="form-check form-switch">
									<input id="all_show_param" class="form-check-input" type="checkbox" checked>
								</div>
							</div>
						</div>
					</div>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
				</div>
				</div>
			</div>
		</div>
    </div>

	<!-- Подключение класса отображаемого объекта, в дальнейшем "отображаемый объект" и "Entity" - синонимы -->
	<script src="{% static "Entity.js" %}"></script>

	<!-- Подключение класса - контейнера хранения Entity. EntityMap наследуется от Map -->
	<script src="{% static "EntityMap.js" %}"></script>


    <script>

		// Функционал подгона высоты родительского div
		$('#fullscreen').css({'height':`${document.documentElement.clientHeight-70}px`});
		window.addEventListener('resize', function() {
			$('#fullscreen').css({'height':`${document.documentElement.clientHeight-70}px`});
		});

		// Функционал поиска Entity в списке
		var options = {
			valueNames: ['model', 'number']
		};
		var userList = new List('objectslist', options);

		// Функционал сортировки в списке
		$(function() {
			$("#list").sortable();
			$("#list").disableSelection();
			$("#liststream").sortable();
			$("#liststream").disableSelection();
		});

		var splitter = $('#widget').split({
			orientation: 'vertical',
			limit: 150,
			position: '85%', 
			onDrag: function(event) {
				map.updateSize();
			}
		});
		$('.vsplitter').css({'background-color': 'darkgrey'});
		
		// Создание объекта-указателя Entity на карте 
		var iconStyle = new ol.style.Style({
			image: new ol.style.Icon({
				anchor: [0.4475, 32],
				anchorXUnits: 'fraction',
				anchorYUnits: 'pixels',
				src: '{% static "icon.png" %}',
			}),
		});

		// Создание контейнера Entity
		entityMap = new EntityMap();

		// Парсинг полученных Entity
		{% for auto_id, value in objects.items %}
			(function(entityMap){
				var entity = new Entity('{{auto_id}}');
				entity.setEnabled = '{{value.enabled}}';
				entity.setNumber = '{{value.number}}';
				entity.setModel = '{{value.model}}';
				entity.setPositionN = '{{value.position_n}}';
				entity.setPositionE = '{{value.position_e}}';

				params = new Map();
				{% for param_id, param_value in value.params.items %}
					params.set('{{param_id}}','{{param_value}}');
				{% endfor %}
				entity.setParams = params;

				streamLinks = new Map();
				{% for link_id, link_value in value.stream_links.items %}
					streamLinks.set('{{link_id}}','{{link_value}}');
				{% endfor %}
				entity.setStreamLinks = streamLinks;
				
				var iconFeature = new ol.Feature({
					geometry: new ol.geom.Point(['{{value.position_e}}', '{{value.position_n}}']),
					name: '{{auto_id}}',
					population: 4000,
					rainfall: 500,
				});
				iconFeature.setStyle(iconStyle);
				entity.setIconFeature = iconFeature;

				entityMap.set('{{auto_id}}', entity);
			})(entityMap);
		{% endfor %}

		var vectorSource = new ol.source.Vector({
			features: entityMap.getIconFeatureList,
		});

		var vectorLayer = new ol.layer.Vector({
			source: vectorSource,
		});

		// Управление SidePanel - панелью со списком Entity
		var ShowListEntity = /*@__PURE__*/(function (Control) {
			function ShowListEntity(opt_options) {
				var options = opt_options || {};
			
				var button = document.createElement('button');
				button.innerHTML = '«'; // Alt + 0171 и Alt + 0187. 

				var element = document.createElement('div');
				element.className = 'rotate-north ol-unselectable ol-control';
				element.appendChild(button);

				ol.control.Control.call(this, {
					element: element,
					target: options.target,
				});
					
				button.addEventListener('click', function(){
					if (this.innerHTML == '«'){
						document.getElementById('sidepanel').hidden = true;
						splitter.refresh();
						map.updateSize();
						this.innerHTML = '»';
					} 
					else {
						//document.getElementById('widget').style.marginLeft = "300px";
						document.getElementById('sidepanel').hidden = false;
						splitter.refresh();
						map.updateSize();
						this.innerHTML = '«';
					}
				}, false);
			}

			if (Control) ShowListEntity.__proto__ = ol.control.Control;
			ShowListEntity.prototype = Object.create( ol.control.Control && ol.control.Control.prototype );
			ShowListEntity.prototype.constructor = ShowListEntity;
			return ShowListEntity;
		}(ol.control.Control));

		// Создание карты
	    var map = new ol.Map({
			controls: ol.control.defaults().extend([
				new ol.control.FullScreen({
					source: 'fullscreen',
				}),
				new ShowListEntity(),
			]),
			target: 'map',
			layers: [
				new ol.layer.Tile({
					source: new ol.source.OSM({
						attributions: "",
					})
				}), 
				vectorLayer,
			],
			view: new ol.View({
				center: ol.proj.fromLonLat([0, 0]),
				zoom: 1
			})
	    });
		
		// Установка начального положения карты
		var position_e = parseFloat('{{position_e}}'.replace(",", "."));
		var position_n = parseFloat('{{position_n}}'.replace(",", "."));
		var zoom = parseFloat('{{zoom}}'.replace(",", "."));
		var view = map.getView();
		view.setCenter([position_e, position_n]);
		view.setZoom(zoom);

		// Инициализация счетчика z-Index'а окон подсказок 
		var zIndexPopupCount = 0;

		// Сохранение положения карты на сервер
		map.on('moveend', function () {
			$.ajax({
				url: '{% url "userdata_save" %}',
				method: 'post',
				dataType:'json',
				data: {
					zoom: view.getZoom(),
					position_e: view.getCenter()[0],
					position_n: view.getCenter()[1],
					csrfmiddlewaretoken: '{{ csrf_token }}',
				},     
				success: function(data){ 
					console.log(data);
				}
			});
			$('#fullscreen').css({'height':`${document.documentElement.clientHeight-70}px`});
			map.updateSize();
		});

		// Заполнение контейнера Entity объектами окон параметров и превью 
		for(var [auto_id, value] of entityMap.entries()) {
			var popup = new ol.Overlay({
				element: document.getElementById('popup_' + auto_id),
				positioning: 'bottom-center',
				stopEvent: false,
				offset: [0, -15],
			});
			value.setPopup = popup;
			map.addOverlay(popup);
		}

		// Функция показа окна с параметрами
		function showWindow (feature){
			var entityId = feature.get('name');
			var coordinates = feature.getGeometry().getCoordinates();
			var hdms = ol.coordinate.toStringHDMS(ol.proj.toLonLat(coordinates));
			var popup = entityMap.getPopupById(entityId);
			var element = popup.getElement();
			
			$(element).popover('dispose');
			popup.setPosition(coordinates);
			
			var flagSetListener = false; // флаг нужен чтобы избежать создание лишних обработчиков
			var params = entityMap.get(entityId).getParams; // map параметров entity
			var streamLinks = entityMap.get(entityId).getStreamLinks; // map видеопотоков entity
			var paramsContent = '';
			var streamLinksContent = '';
			var streamLinksIndicators = '';
			var streamLinksIndicatorsFull = '';

			// Формирование блока со списком параметров:
			// Данные настроек (показать(скрыть)) параметр хранятся в куки
			// Ключ куки: id переключателя параметра в настройках
			// Значение: "checked" или если не определен - показать, "" - скрыть 
			for(var [param_id, param_value] of params) {
				if($.cookie(`sw_${param_id}_${entityId}`) != ''){
					paramsContent+= `<p id="p_sw_${param_id}_${entityId}" class="m-0">${param_id}: ${param_value}</p>`;
				}	
				else{
					paramsContent+= `<p id="p_sw_${param_id}_${entityId}" class="m-0" style="display:none;">${param_id}: ${param_value}</p>`;
				}				
			}
			
			// Формирование блока отображения видеопотока
			var countCarousel = 0;
			for(var [link_id, link_value] of streamLinks) {
				if(!countCarousel){
					streamLinksContent+= `
						<div class="carousel-item active">
							<div class="title-prd">
								<p class="title-prt">${link_id}</p>
							</div>
							<img src=${link_value} class="d-block w-100" alt="Видео не найдено" onerror="this.src ='{% static "videostream.png" %}'">
						</div>
					`;
					streamLinksIndicators+=`
						<button type="button" style="background-color: green;" data-bs-target="#carousel_${entityId}" data-bs-slide-to="${countCarousel}" class="active" aria-current="true" aria-label="Slide ${countCarousel+1}"></button>
					`;
					streamLinksIndicatorsFull+=`
						<button type="button" data-bs-target="#full_carousel_${entityId}" data-bs-slide-to="${countCarousel}" class="active" aria-current="true" aria-label="Slide ${countCarousel+1}"></button>
					`;
				}
				else{
					streamLinksContent+= `
						<div class="carousel-item">
							<div class="title-prd">
								<p class="title-prt">${link_id}</p>
							</div>
							<img src=${link_value} class="d-block w-100" alt="Видео не найдено" onerror="this.src ='{% static "videostream.png" %}'">
						</div>
					`;
					streamLinksIndicators+=`
						<button type="button" style="background-color: green;" data-bs-target="#carousel_${entityId}" data-bs-slide-to="${countCarousel}" aria-current="true" aria-label="Slide ${countCarousel+1}"></button>
					`;
					streamLinksIndicatorsFull+=`
						<button type="button" data-bs-target="#full_carousel_${entityId}" data-bs-slide-to="${countCarousel}" aria-current="true" aria-label="Slide ${countCarousel+1}"></button>
					`;
				}
				
				countCarousel+=1;
			}
			
			// Если нет видеопотоков
			if(!countCarousel){
				streamLinksContent+= `
					<div class="carousel-item active">
						<img src="{% static "videostream.png" %}" class="d-block w-100" alt="Нет видеопотоков">
					</div>
				`;
			}

			// Инициализация окна над указателем.
			// Выполняем заполнение контентом только при событии появления окна
			$(element).popover({
				container: element,
				placement: 'top',
				animation: false,
				html: true,
				title : '<div></div>',
				content:'',

			}).on('shown.bs.popover', function (eventShown) {
				if(!flagSetListener){	
					$(element).find('.popover-body').html(
						`<div class="params p-1">
							<div class="params-lines">
								${paramsContent}
							</div>
						</div>
						<div class="params-btns">
							<span id="span_close_min" class="badge set-cursor settings-button close-button my-1 mx-1">x</span>
							<span id="span_more" class="badge set-cursor settings-button more-button mb-1 mx-1">»</span>
						</div>
						<div class="more-settings p-2">
							<!--<img src={% static "videostream.png" %} width="150px">-->
							<div id="carousel_${entityId}" class="carousel slide" style="padding-bottom: 20px;" data-bs-ride="carousel" data-bs-interval="false">								  	
								<div class="carousel-inner">
									${streamLinksContent}
								</div>
								<div class="carousel-indicators carousel-preview">
									${streamLinksIndicators}
								</div>
								<!--<button class="carousel-control-prev" type="button" data-bs-target="#carousel_${entityId}" data-bs-slide="prev">
									<span class="carousel-control-prev-icon" aria-hidden="true"></span>
									<span class="visually-hidden">Previous</span>
								</button>
								<button class="carousel-control-next" type="button" data-bs-target="#carousel_${entityId}" data-bs-slide="next">
									<span class="carousel-control-next-icon" aria-hidden="true"></span>
									<span class="visually-hidden">Next</span>
								</button>-->
							</div>
							<!--<div class="d-flex justify-content-end mt-1">
								<span id="span_less" class="badge set-cursor settings-button">«</span>
								<span id="span_video" class="badge mx-1 set-cursor settings-button">Видео</span>
								<span id="span_settings" class="badge set-cursor settings-button">Настройки</span>
							</div>-->
						</div>`
					);

					$(element).find('.popover-header').html(
						`<div class="row">
							<div class="col-7">
								<span>${entityMap.getModelById(entityId)}</span>
							</div> 
							<div class="col-5" style="padding-right: 5px;">
								<div class="d-flex justify-content-end" style="padding-bottom: 5px;">									
									<span id="span_settings" class="badge set-cursor settings-button">
										<svg xmlns="http://www.w3.org/2000/svg" width="10" height="10" fill="currentColor" class="bi bi-gear" viewBox="0 0 16 16">
											<path d="M8 4.754a3.246 3.246 0 1 0 0 6.492 3.246 3.246 0 0 0 0-6.492zM5.754 8a2.246 2.246 0 1 1 4.492 0 2.246 2.246 0 0 1-4.492 0z"></path>
											<path d="M9.796 1.343c-.527-1.79-3.065-1.79-3.592 0l-.094.319a.873.873 0 0 1-1.255.52l-.292-.16c-1.64-.892-3.433.902-2.54 2.541l.159.292a.873.873 0 0 1-.52 1.255l-.319.094c-1.79.527-1.79 3.065 0 3.592l.319.094a.873.873 0 0 1 .52 1.255l-.16.292c-.892 1.64.901 3.434 2.541 2.54l.292-.159a.873.873 0 0 1 1.255.52l.094.319c.527 1.79 3.065 1.79 3.592 0l.094-.319a.873.873 0 0 1 1.255-.52l.292.16c1.64.893 3.434-.902 2.54-2.541l-.159-.292a.873.873 0 0 1 .52-1.255l.319-.094c1.79-.527 1.79-3.065 0-3.592l-.319-.094a.873.873 0 0 1-.52-1.255l.16-.292c.893-1.64-.902-3.433-2.541-2.54l-.292.159a.873.873 0 0 1-1.255-.52l-.094-.319zm-2.633.283c.246-.835 1.428-.835 1.674 0l.094.319a1.873 1.873 0 0 0 2.693 1.115l.291-.16c.764-.415 1.6.42 1.184 1.185l-.159.292a1.873 1.873 0 0 0 1.116 2.692l.318.094c.835.246.835 1.428 0 1.674l-.319.094a1.873 1.873 0 0 0-1.115 2.693l.16.291c.415.764-.42 1.6-1.185 1.184l-.291-.159a1.873 1.873 0 0 0-2.693 1.116l-.094.318c-.246.835-1.428.835-1.674 0l-.094-.319a1.873 1.873 0 0 0-2.692-1.115l-.292.16c-.764.415-1.6-.42-1.184-1.185l.159-.291A1.873 1.873 0 0 0 1.945 8.93l-.319-.094c-.835-.246-.835-1.428 0-1.674l.319-.094A1.873 1.873 0 0 0 3.06 4.377l-.16-.292c-.415-.764.42-1.6 1.185-1.184l.292.159a1.873 1.873 0 0 0 2.692-1.115l.094-.319z"></path>
										</svg>
									</span>
									<span id="span_less" class="badge set-cursor settings-button ms-1">
										<svg xmlns="http://www.w3.org/2000/svg" width="10" height="10" fill="currentColor" class="bi bi-dash-lg" viewBox="0 0 16 16">
											<path d="M0 8a1 1 0 0 1 1-1h14a1 1 0 1 1 0 2H1a1 1 0 0 1-1-1z"/>
										</svg>
									</span>
									<span id="span_close" class="badge set-cursor settings-button ms-1">
										<svg xmlns="http://www.w3.org/2000/svg" width="10" height="10" fill="currentColor" class="bi bi-x-lg" viewBox="0 0 16 16">
											<path d="M1.293 1.293a1 1 0 0 1 1.414 0L8 6.586l5.293-5.293a1 1 0 1 1 1.414 1.414L9.414 8l5.293 5.293a1 1 0 0 1-1.414 1.414L8 9.414l-5.293 5.293a1 1 0 0 1-1.414-1.414L6.586 8 1.293 2.707a1 1 0 0 1 0-1.414z"/>
										</svg>
									</span>
								</div>
							</div>
						</div>`
					);

					// Применение глобыльных настроек
					var rng1 = document.getElementById('customRange1');
					var rng2 = document.getElementById('customRange2');
					var rng3 = document.getElementById('customRange3');
					$('.params-lines').css({'font-size': rng1.value +'px'});
					$('.carousel-inner').css({'width': rng2.value +'px'});
					$('.popover').css({'opacity': rng3.value});

					// Обработка закрытия окна
					/*$(element).find('#span_close').on('click', function(e) {
						$(element).popover('dispose');
					});*/

					// Обработка нажатия на кнопку "Видео" - подробный видеопоток от Entity
					$(element).find('#span_video').on('click', function(e) {
						var videoModal = new bootstrap.Modal(document.getElementById('videoModal'), {
							keyboard: false
						});
						document.getElementById('videoModalTitle').innerHTML = `Видеопоток ${entityMap.getModelById(entityId)}`;
						document.getElementById('videoModalContent').innerHTML = `
							<div id="full_carousel_${entityId}" class="carousel slide" data-bs-ride="carousel" data-bs-interval="false">
								<div class="carousel-indicators">
									${streamLinksIndicatorsFull}
								</div>
								<div class="carousel-inner">
									${streamLinksContent}
								</div>
								<button class="carousel-control-prev" type="button" data-bs-target="#full_carousel_${entityId}" data-bs-slide="prev">
									<span class="carousel-control-prev-icon" aria-hidden="true"></span>
									<span class="visually-hidden">Previous</span>
								</button>
								<button class="carousel-control-next" type="button" data-bs-target="#full_carousel_${entityId}" data-bs-slide="next">
									<span class="carousel-control-next-icon" aria-hidden="true"></span>
									<span class="visually-hidden">Next</span>
								</button>
							</div>
						`;
						videoModal.show();
					});

					// Обработка нажатия на кнопку "Настройки" - локальные настройки Entity
					$(element).find('#span_settings').on('click', function(e) {
						var settingsModal = new bootstrap.Modal(document.getElementById('settingsModal'), {
							keyboard: false
						});
						document.getElementById('settingsModalTitle').innerHTML = `Настройки ${entityMap.getModelById(entityId)}`;
						
						var settingsContent = '';
						for(var [param_id, param_value] of params) {
							var isCheck = 'checked';
							if($.cookie(`sw_${param_id}_${entityId}`) != undefined){
								isCheck = $.cookie(`sw_${param_id}_${entityId}`);
							}
							
							settingsContent+= `
								<div class="row">
									<div class="col">
										<label for="sw_${param_id}_${entityId}" class="form-label">${param_id}</label>
									</div>
									<div class="col-2 gsettings-col">
										<div class="form-check form-switch">
											<input id="sw_${param_id}_${entityId}" class="form-check-input" type="checkbox" ${isCheck}>
										</div>
									</div>
								</div>
							`;								
						}
						document.getElementById('settingsModalContent').innerHTML = settingsContent;
						
						for(var [param_id, param_value] of params) {
							var swParam = document.getElementById(`sw_${param_id}_${entityId}`);
							swParam.addEventListener("change", function () {
								if (this.checked){
									$.cookie(`${this.id}`, 'checked');
									$(`#p_${this.id}`).css({'display': ''});
								}
								else{
									$.cookie(`${this.id}`, '');
									$(`#p_${this.id}`).css({'display': 'none'});
								}
							}, false);
							
						}						
						settingsModal.show();
					});

					// Обработка нажатия на кнопку "»" - показать превью
					$(element).find('#span_more').on('click', function(e) {
						settings_block = $(element).find('.more-settings');
						header_block = $(element).find('.popover-header');
						button_more = $(element).find('#span_more');
						button_close = $(element).find('#span_close_min');
						if(settings_block.css('display')=='none'){
							settings_block.css({'display':'block'});
							header_block.css({'display':'block'});
							button_more.css({'display':'none'});
							button_close.css({'display':'none'});
						}
						else{
							settings_block.css({'display':'none'});
							header_block.css({'display':'none'});
							button_more.css({'display':'inline-flex'});
							button_close.css({'display':'inline-flex'});
						}
					});

					// Обработка нажатия на кнопку "-" - скрыть превью
					$(element).find('#span_less').on('click', function(e) {
						settings_block = $(element).find('.more-settings');
						header_block = $(element).find('.popover-header');
						button_more = $(element).find('#span_more');
						button_close = $(element).find('#span_close_min');
						if(settings_block.css('display')=='block'){
							settings_block.css({'display':'none'});
							header_block.css({'display':'none'});
							button_more.css({'display':'inline-flex'});
							button_close.css({'display':'inline-flex'});
						}
						else{
							settings_block.css({'display':'block'});
							header_block.css({'display':'block'});
							button_more.css({'display':'none'});
							button_close.css({'display':'none'});
						}
					});

					// Обработка закрытия окна
					$(element).find('#span_close').on('click', function(e) {
						$(element).popover('dispose');
					});
					$(element).find('#span_close_min').on('click', function(e) {
						$(element).popover('dispose');
					});

					flagSetListener=true;
				}

			}).on('hide.bs.popover', function (eventShown) {					
				$(element).popover('toggle');
			});

			zIndexPopupCount +=1;
			$(element).parent().css({"z-index":zIndexPopupCount});
			$(element).popover('show');

			// При нажатии на окно, оно появляется поверх остальных окон
			$(element).on('click', function (eventShown) {	
				zIndexPopupCount +=1;
				$(element).parent().css({"z-index":zIndexPopupCount});	
			});
		}

		// Нажатие на иконку Entity
		map.on('click', function (evt) {
			// Содержимое окон параметров и превью заполняется только при появлении этого окна
			// Костыли, написанные в этом блоке, позволяют динамически формировать содержимое этих окон
			// Не пытайтесь разобраться и понять неэффективные методы, используемые в этом блоке
			// Лучше перепишите по-новой, либо используйте доступный функционал

			// Суть ниженаписанного (функции showWindow) состоит в следующем:
			// Сначала динамически формируются блоки контекста окна, в зависими от значения переменных
			// Эти блоки включаются в другие, более общие блоки
			// Затем, по идентификатору указателя(иконки) по которому произошло нажатие, контекст появляется в окнах над ними
			
			var feature = map.forEachFeatureAtPixel(evt.pixel, function (feature) {
				return feature;
			});
			if (feature) {
				showWindow(feature);
			}
		});

		// Изменение курсора при наведении на указатель Entity
		map.on('pointermove', function (evt) {
			var hit = this.forEachFeatureAtPixel(evt.pixel, function(feature, layer) {
				return true;
			}); 
			if (hit) {
				this.getTargetElement().style.cursor = 'pointer';
			} else {
				this.getTargetElement().style.cursor = '';
			}
		});

		// Функция отрисовки фокуса (круга) на указателе Entity
		function drowCircle(feature) {
			var start = new Date().getTime();
			var listenerKey = vectorLayer.on('postrender', animate);
			function animate(event) {
				var vectorContext = ol.render.getVectorContext(event);
				var frameState = event.frameState;
				var flashGeom = feature.get('geometry');
				var elapsed = frameState.time - start;
				var duration = 1000;
				var elapsedRatio = elapsed / duration;
				// radius will be 5 at start and 30 at end.
				var radius = ol.easing.easeOut(elapsedRatio) * 20 + 5;
				var opacity = ol.easing.easeOut(1 - elapsedRatio);

				var style = new ol.style.Style({
				image: new ol.style.Circle({
					radius: radius,
					stroke: new ol.style.Stroke({
					color: 'rgba(255, 0, 0, ' + opacity + ')',
					width: 0.25 + opacity,
					}),
				}),
				});

				vectorContext.setStyle(style);
				vectorContext.drawGeometry(flashGeom);
				if (elapsed > duration) {
				ol.Observable.unByKey(listenerKey);
				return;
				}
				// tell OpenLayers to continue postrender animation
				map.render();
			}
		}

		// Обработка событий фокуса и показа/скрытия указателей Entity
		var view_button_show = document.querySelectorAll(".show");
		var view_switch = document.querySelectorAll(".view-object");
		for (var i = 0; i < view_button_show.length; i++) {
			view_button_show[i].addEventListener("click", function () {
				var car_id = this.getAttribute('id');
				let featureIcon = entityMap.getIconFeatureById(car_id);
				let p = featureIcon.get('geometry').getFirstCoordinate();
				view.setCenter([parseFloat(p[0]), parseFloat(p[1])]);
				drowCircle(featureIcon);
				let sws = document.getElementsByClassName('view-object');
				for(var j = 0; j < sws.length; j++){
					if (sws[j].getAttribute('id') == car_id){
						if(!sws[j].checked){
							sws[j].click();
						}
						break;
					}
				}
			}, false);

			view_switch[i].addEventListener("change", function () {
				var car_id = this.getAttribute('id');
				let featureIcon = entityMap.getIconFeatureById(car_id);
				if (!this.checked){
					featureIcon.setStyle(new ol.style.Style({}));
					var p = entityMap.getPopupById(car_id).getElement();
					$(p).popover('dispose');
					$.cookie(`view_${car_id}`, '');
				} else {
					featureIcon.setStyle(iconStyle);
					$.cookie(`view_${car_id}`, 'checked');
				}
			}, false);
		}

		// Обработка события показа(скрытия) всех указателей entity
		var view_switch_all = document.getElementById("all_show");
		view_switch_all.addEventListener("change", function () {
			for(var j = 0; j < view_button_show.length; j++){
				if (view_switch[j].checked != this.checked){
					view_switch[j].click();
				}
			}
		}, false);

		// Обработка события показа(скрытия) всех окон
		var view_switch_all = document.getElementById("all_show_param");
		view_switch_all.addEventListener("change", function () {
			if (this.checked){
				for(var [auto_id, value] of entityMap.entries()) {
					var swElement = document.getElementsByClassName('view-object')[auto_id];
					if (swElement.checked){
						showWindow(value.getIconFeature);
					}
				}
			}
			else{
				for(var [auto_id, value] of entityMap.entries()) {
					var element = value.getPopup.getElement();
					$(element).popover('dispose');
				}
			}
		}, false);

		// Считывание из куки видимость каждого Entity
		for(var j = 0; j < view_switch.length; j++){
			if ($.cookie(`view_${view_switch[j].id}`) == ''){
				view_switch[j].click();
			}	
		}

		// Обработка ползунков настроек
		function dragRange1(){
			var rng = document.getElementById('customRange1');
			$('#contentRange1').html(rng.value +'px');
			$('.params-lines').css({'font-size': rng.value +'px'});
			saveGlobalSettings('settings_size_text', rng.value);
		}
		function dragRange2(){
			var rng = document.getElementById('customRange2');
			$('#contentRange2').html(rng.value +'px');
			$('.carousel-inner').css({'width': rng.value +'px'});
			saveGlobalSettings('settings_size_preview', rng.value);
		}
		function dragRange3(){
			var rng = document.getElementById('customRange3');
			$('#contentRange3').html(rng.value * 100 +'%');
			$('.popover').css({'opacity': rng.value});
			saveGlobalSettings('settings_opacity_windows', rng.value);
		}

		// Cохранение глобальных настроек
		function saveGlobalSettings(settingsId, settingsValue){
			$.ajax({
				url: '{% url "userdata_save" %}',
				method: 'post',
				dataType:'json',
				data: {
					settingsId: settingsId,
					settingsValue: settingsValue,
					csrfmiddlewaretoken: '{{ csrf_token }}',
				},     
				success: function(data){ 
					console.log(data);
				}
			});
		}

    </script>
	
	<script>
		setInterval(function(){
			/*$.ajax({
				url: '{% url "get_coor" %}',
				method: 'post',
				dataType:'json',
				data: {
					csrfmiddlewaretoken: '{{ csrf_token }}',
				},     
				success: function(data){ 
					for(var key in data){
						iconMap.get(key).set('geometry', new ol.geom.Point([data[key]['position_e'], data[key]['position_n']]));
					}
				}
			});*/
			
			for(var i = 1; i < 5; i++){
				var coordinates = entityMap.getIconFeatureById(`auto${i.toString()}`).getGeometry().getCoordinates();
				var px = parseFloat(coordinates[0])+5.0;
				var py = parseFloat(coordinates[1])+2.0;
				
				entityMap.getIconFeatureById(`auto${i.toString()}`).setGeometry(new ol.geom.Point([px,py]));
				entityMap.getPopupById(`auto${i.toString()}`).setPosition(coordinates);
			}
			for(var i = 5; i < 9; i++){
				var coordinates = entityMap.getIconFeatureById(`auto${i.toString()}`).getGeometry().getCoordinates();
				var px = parseFloat(coordinates[0])-1.0;
				var py = parseFloat(coordinates[1])+6.0;
				
				entityMap.getIconFeatureById(`auto${i.toString()}`).setGeometry(new ol.geom.Point([px,py]));
				entityMap.getPopupById(`auto${i.toString()}`).setPosition(coordinates);
			}
			for(var i = 9; i < 13; i++){
				var coordinates = entityMap.getIconFeatureById(`auto${i.toString()}`).getGeometry().getCoordinates();
				var px = parseFloat(coordinates[0])-3.0;
				var py = parseFloat(coordinates[1])-7.0;
				
				entityMap.getIconFeatureById(`auto${i.toString()}`).setGeometry(new ol.geom.Point([px,py]));
				entityMap.getPopupById(`auto${i.toString()}`).setPosition(coordinates);
			}
			for(var i = 13; i < 16; i++){
				var coordinates = entityMap.getIconFeatureById(`auto${i.toString()}`).getGeometry().getCoordinates();
				var px = parseFloat(coordinates[0])+3.0;
				var py = parseFloat(coordinates[1])-1.0;
				
				entityMap.getIconFeatureById(`auto${i.toString()}`).setGeometry(new ol.geom.Point([px,py]));
				entityMap.getPopupById(`auto${i.toString()}`).setPosition(coordinates);
			}
		},100);

		/*setInterval(function(){
			minS = Math.ceil(25);
			maxS = Math.floor(60);
			minR = Math.ceil(1200);
			maxR = Math.floor(2500);
			for(var i = 1; i < 16; i++){
				pop = entityMap.getPopupById(`auto${i.toString()}`).getElement();
				$(pop).find(`#p_sw_Скорость_auto${i.toString()}`).html(`
					Скорость: ${Math.floor(Math.random() * (maxS - minS)) + minS}км/ч
				`);
				$(pop).find(`#p_sw_Обороты_auto${i.toString()}`).html(`
					Обороты: ${Math.floor(Math.random() * (maxR - minR)) + minR}
				`);
			}
		},1000);*/

	</script>
{% endblock %}