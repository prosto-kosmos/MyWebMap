{% extends 'index.html' %}
{% load static %}
{% block nav_title %}
    Карта
{% endblock %}

{% block top_nav_buttons_left %}
    <li class="nav-item">
        {% url 'index_url' as index_page_url %}
        <a class="nav-link btn-secondary" href="{{index_page_url}}">На главную</a>
    </li>
{% endblock %}

{% block css %}
	<!--   jQuery и OpenLayers можно скачать на официальных сайтах и использовать оффлайн -->
	<!-- 		  jQuery      - https://jquery.com/download/ -->
	<!-- 		OpenLayers    - https://openlayers.org/download/ -->

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/openlayers/openlayers.github.io@master/en/v6.5.0/css/ol.css" type="text/css">
    <script type="text/javascript" src="https://cdn.jsdelivr.net/gh/openlayers/openlayers.github.io@master/en/v6.5.0/build/ol.js"></script>
{% endblock %}

{% csrf_token %}

{% block content %}
    <div id="map" class="map" style="height: 600px; width: 100%;}"></div>
    <script type="text/javascript">
		
	    var map = new ol.Map({
			target: 'map',
			layers: [
			  new ol.layer.Tile({
				source: new ol.source.OSM()
			  })
			],
			view: new ol.View({
			  center: ol.proj.fromLonLat([0, 0]),
			  zoom: 1
			})
	    });
		position_e = parseFloat('{{position_e}}'.replace(",", "."))
		position_n = parseFloat('{{position_n}}'.replace(",", "."))
		zoom = parseFloat('{{zoom}}'.replace(",", "."))

		var view = map.getView();
		view.setCenter([position_e, position_n]);
		view.setZoom(zoom);

		map.on('moveend', function () {
			$.ajax({
				url: '{% url "userdata_save" %}',
				method: 'post',
				dataType:'json',
				data: {
					zoom: view.getZoom(),
					position_e: view.getCenter()[0],
					position_n: view.getCenter()[1],
					csrfmiddlewaretoken: '{{ csrf_token }}',
				},     
				success: function(data){ 
					console.log(data);
				}
			});
		});

    </script>
{% endblock %}